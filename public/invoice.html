<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice</title>
  <link rel="stylesheet" href="layout.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <script type="text/javascript" src="invoice.js" defer></script>

  <script>
    // Navbar avatar init
    (function initNavAvatar() {
      try {
        var url = localStorage.getItem('user_photo_url');
        var email = localStorage.getItem('user_email');
        var img = document.getElementById('navAvatar');
        var ni = document.getElementById('navInitial');
        if (url && img) { img.src = url; img.style.display = 'block'; if (ni) ni.style.display = 'none'; return; }
        if (email && ni) { ni.textContent = (email.split('@')[0] || 'U').slice(0, 1).toUpperCase(); ni.style.display = 'flex'; }
      } catch (e) {}
    })();
  </script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase compat (avatar fallback) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    (function ensureNavAvatar() {
      try {
        var url = localStorage.getItem('user_photo_url');
        var img = document.getElementById('navAvatar');
        if (url && img) { img.src = url; img.style.display = 'block'; return; }
      } catch (e) {}

      try {
        if (!window.firebase || !firebase.apps || !firebase.apps.length) {
          firebase.initializeApp({
            apiKey: "AIzaSyD7eBbx6u7Tmi6Kr097A5yVL_NSRbsId6g",
            authDomain: "client-self-service-portal.firebaseapp.com",
            projectId: "client-self-service-portal",
            storageBucket: "client-self-service-portal.appspot.com",
            messagingSenderId: "423657022971",
            appId: "1:423657022971:web:d58cd5730591b0e121175e",
            measurementId: "G-EDW6QM7B76"
          });
        }
        var auth = firebase.auth();
        var db = firebase.firestore();
        auth.onAuthStateChanged(function (user) {
          if (user && user.uid) {
            db.collection('profiles').doc(user.uid).get().then(function (snap) {
              var p = snap.data() || {};
              if (p.photoURL) {
                try { localStorage.setItem('user_photo_url', p.photoURL); } catch (e) {}
                var img = document.getElementById('navAvatar');
                if (img) { img.src = p.photoURL; img.style.display = 'block'; }
              } else if (p.email) {
                var ni = document.getElementById('navInitial');
                if (ni) { ni.textContent = (p.email.split('@')[0] || 'U').slice(0, 1).toUpperCase(); ni.style.display = 'flex'; }
              }
            }).catch(function () {});
          }
        });
      } catch (e) {}
    })();
  </script>
</head>

<body>
  <div class="navbar">
    <div class="left">
      <span class="menu-btn" onclick="toggleSidebar()">☰</span>
    </div>
    <div class="center links">
      <a href="invoice.html" data-i18n="nav.home">Home</a>
      <a href="index.html#contact" data-i18n="nav.contact">Contact Us</a>
    </div>
    <div class="right profile-icon">
      <select id="langSel" aria-label="Language">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
        <option value="de">Deutsch</option>
        <option value="ar">العربية</option>
        <option value="ja">日本語</option>
      </select>
      <a class="nav-avatar" href="profile.html" aria-label="Profile" title="Open Profile">
        <img id="navAvatar" alt="avatar" style="width:32px;height:32px;border-radius:999px;object-fit:cover;display:block;cursor:pointer;" />
        <span id="navInitial" class="nav-initial" style="display:none;">U</span>
      </a>
    </div>
  </div>

  <div class="sidebar modern" id="sidebar" aria-label="Sidebar">
    <div class="sidebar-inner">
      <nav class="nav">
        <a href="invoice.html" class="nav-item" title="Invoice">
          <span class="material-symbols-outlined">bar_chart_4_bars</span>
          <span class="label" data-i18n="sidebar.invoice">Invoice</span>
        </a>
        <a href="ticket.html" class="nav-item" title="Ticket">
          <span class="material-symbols-outlined">shield</span>
          <span class="label" data-i18n="sidebar.tracking">Tracking</span>
        </a>
        <a href="settings.html" class="nav-item" title="Settings">
          <span class="material-symbols-outlined">settings</span>
          <span class="label" data-i18n="sidebar.settings">Settings</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user">
          <div class="avatar">b</div>
          <div class="meta">
            <div class="name">Client</div>
            <button class="signout" onclick="logout()" data-i18n="auth.signOut">Sign out</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="pag">
      <div class="invoice-dashboard">
        <h2 data-i18n="invoice.title">Invoice Dashboard</h2>

        <div class="filters">
          <input type="text" id="searchInvoice" placeholder="Search by Invoice ID" data-i18n-placeholder="invoice.search" />
          <input type="date" id="startDate">
          <input type="date" id="endDate">
          <select id="statusFilter">
            <option value="" data-i18n="invoice.all">All</option>
            <option value="Paid" data-i18n="invoice.paid">Paid</option>
            <option value="Pending" data-i18n="invoice.pending">Pending</option>
            <option value="Overdue" data-i18n="invoice.overdue">Overdue</option>
          </select>
        </div>

        <table id="invoiceTable" border="1">
          <thead>
            <tr class="tr">
              <th data-i18n="invoice.table.invoice">Invoice #</th>
              <th data-i18n="invoice.table.date">Date</th>
              <th data-i18n="invoice.table.service">Service</th>
              <th data-i18n="invoice.table.amount">Amount</th>
              <th data-i18n="invoice.table.status">Status</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
          </tbody>

          <!-- Data + Filtering + Downloads -->
          <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
            import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

            const firebaseConfig = {
              apiKey: "AIzaSyD7eBbx6u7Tmi6Kr097A5yVL_NSRbsId6g",
              authDomain: "client-self-service-portal.firebaseapp.com",
              projectId: "client-self-service-portal",
              storageBucket: "client-self-service-portal.appspot.com",
              messagingSenderId: "423657022971",
              appId: "1:423657022971:web:d58cd5730591b0e121175e"
            };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            const tbody = document.getElementById('invoiceTableBody');
            const searchEl = document.getElementById('searchInvoice');
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            const statusEl = document.getElementById('statusFilter');

            let allInvoices = [];
            let filtered = [];
            let selectedIds = new Set(); // stores selection keys

            function normalizeDate(d) {
              if (!d) return null;
              if (d.toDate) return d.toDate();
              if (typeof d === 'string') {
                const dd = new Date(d);
                return isNaN(dd) ? null : dd;
              }
              if (d instanceof Date) return d;
              return null;
            }

            function fmtDate(inv) {
              const dt = normalizeDate(inv.date);
              return dt ? dt.toLocaleDateString() : '';
            }

            function fmtAmount(inv) {
              const amt = typeof inv.amount === 'number' ? inv.amount : Number(inv.amount) || 0;
              try { return new Intl.NumberFormat(undefined, { style: 'currency', currency: inv.currency || 'USD' }).format(amt); }
              catch { return String(amt); }
            }

            function keyOf(inv) {
              return inv.invoiceNumber || inv.id || inv.invoiceId || JSON.stringify(inv);
            }

            function renderRows(list) {
              tbody.innerHTML = '';
              if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No invoices found.</td></tr>';
                return;
              }
              list.forEach(inv => {
                const k = keyOf(inv);
                const tr = document.createElement('tr');
                if (selectedIds.has(k)) tr.classList.add('selected');
                tr.dataset.key = k;
                tr.innerHTML = `
                  <td>${inv.invoiceNumber || ''}</td>
                  <td>${fmtDate(inv)}</td>
                  <td>${inv.service || ''}</td>
                  <td>${fmtAmount(inv)}</td>
                  <td>${inv.status || ''}</td>
                `;
                tr.addEventListener('click', () => {
                  if (selectedIds.has(k)) {
                    selectedIds.delete(k);
                    tr.classList.remove('selected');
                  } else {
                    selectedIds.add(k);
                    tr.classList.add('selected');
                  }
                });
                tbody.appendChild(tr);
              });
            }

            function applyFilters() {
              const q = (searchEl?.value || '').toLowerCase().trim();
              const st = statusEl?.value || '';
              const start = startEl?.value ? new Date(startEl.value) : null;
              const end = endEl?.value ? new Date(endEl.value) : null;
              if (end) { end.setHours(23, 59, 59, 999); }

              filtered = allInvoices.filter(inv => {
                const idText = String(inv.invoiceNumber || inv.id || '').toLowerCase();
                if (q && !idText.includes(q)) return false;
                if (st && (inv.status !== st)) return false;

                const dt = normalizeDate(inv.date);
                if (start && dt && dt < start) return false;
                if (end && dt && dt > end) return false;

                return true;
              });

              renderRows(filtered);
            }

            // Downloads
            window.downloadCSV = function () {
              const rows = [['Invoice #', 'Date', 'Service', 'Amount', 'Status'].join(',')];
              filtered.forEach(inv => {
                rows.push([
                  inv.invoiceNumber || '',
                  fmtDate(inv),
                  inv.service || '',
                  (typeof inv.amount === 'number' ? inv.amount : Number(inv.amount) || 0),
                  inv.status || ''
                ].join(','));
              });
              const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'invoices.csv'; a.click();
              URL.revokeObjectURL(url);
            };

            window.downloadSelectedPDF = function () {
              const chosen = filtered.filter(inv => selectedIds.has(keyOf(inv)));
              if (!chosen.length) {
                alert('Please select at least one invoice row first.');
                return;
              }
              const { jsPDF } = window.jspdf;
              chosen.forEach(inv => {
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text('Invoice', 90, 20);
                doc.setFontSize(12);
                doc.text(`Invoice Number: ${inv.invoiceNumber || ''}`, 20, 40);
                doc.text(`Date: ${fmtDate(inv)}`, 20, 50);
                doc.text(`Service: ${inv.service || ''}`, 20, 60);
                doc.text(`Amount: ${fmtAmount(inv)}`, 20, 70);
                doc.text(`Status: ${inv.status || ''}`, 20, 80);
                doc.setFontSize(10); doc.text('Thank you for your business!', 20, 100);
                const name = (inv.invoiceNumber || 'invoice') + '.pdf';
                doc.save(name);
              });
            };

            window.downloadAllPDF = function () {
              if (!filtered.length) {
                alert('No invoices to export.');
                return;
              }
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              const title = (window.I18N && window.currentLang && window.I18N[window.currentLang]?.invoice?.listTitle) || "Invoice List";
              doc.text(title, 10, 10);
              const head = [['Invoice #', 'Date', 'Service', 'Amount', 'Status']];
              const body = filtered.map(inv => [
                inv.invoiceNumber || '',
                fmtDate(inv),
                inv.service || '',
                fmtAmount(inv),
                inv.status || ''
              ]);
              doc.autoTable({ head, body, startY: 18 });
              doc.save('invoices.pdf');
            };

            // Wire filters
            [searchEl, startEl, endEl, statusEl].forEach(el => {
              if (!el) return;
              const evt = el.tagName === 'INPUT' ? 'input' : 'change';
              el.addEventListener(evt, applyFilters);
            });

            // Realtime data
            onAuthStateChanged(auth, user => {
              if (!user) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Please log in to view invoices.</td></tr>';
                return;
              }
              const qy = query(collection(db, "invoices"), where("userId", "==", user.uid));
              onSnapshot(qy, qs => {
                allInvoices = [];
                qs.forEach(doc => allInvoices.push({ id: doc.id, ...doc.data() }));
                // remove selections that no longer exist
                const keys = new Set(allInvoices.map(keyOf));
                selectedIds.forEach(k => { if (!keys.has(k)) selectedIds.delete(k); });
                applyFilters();
              });
            });
          </script>
        </table>

        <div class="downloads">
          <button onclick="downloadSelectedPDF()" data-i18n="invoice.downloadSelected">Download Selected PDF</button>
          <button onclick="downloadAllPDF()" data-i18n="invoice.downloadAll">Download All PDF</button>
          <button onclick="downloadCSV()" data-i18n="invoice.downloadCsv">Download CSV</button>
        </div>

        <style>
          .invoice-dashboard { max-width: 1000px; margin: 40px auto; background: #fff; color: #2d3748; padding: 32px 28px 28px; border-radius: 18px; box-shadow: 0 6px 24px rgba(60,72,88,0.10), 0 1.5px 6px rgba(60,72,88,0.08); font-family: "Poppins","Segoe UI",Tahoma,sans-serif; }
          .invoice-dashboard h2 { text-align: center; margin-bottom: 24px; font-size: 2rem; font-weight: 700; color: #6366f1; letter-spacing: 1px; }
          .filters { display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 28px; justify-content: center; }
          .filters input, .filters select { padding: 12px 16px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 15px; background: #f7fafc; color: #2d3748; transition: border .2s, box-shadow .2s; outline: none; min-width: 180px; box-shadow: 0 1px 3px rgba(60,72,88,0.03); }
          .filters input[type="date"] { min-width: 140px; }
          .filters input:focus, .filters select:focus { border-color: #6366f1; background: #fff; box-shadow: 0 0 0 2px #e0e7ff; }
          #invoiceTable { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; font-size: 15px; background: #fff; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(60,72,88,0.04); }
          #invoiceTable thead { background: #f3f4f6; color: #2d3748; text-align: left; }
          #invoiceTable th, #invoiceTable td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; }
          #invoiceTable tbody tr { transition: background .18s; }
          #invoiceTable tbody tr:hover { background: #f1f5f9; cursor: pointer; }
          #invoiceTable tbody tr.selected { background: #e0e7ff !important; }
          .downloads { margin-top: 24px; text-align: center; }
          .downloads button { background: linear-gradient(90deg, #7c3aed 0%, #6366f1 100%); color: #fff; border: none; padding: 12px 22px; margin: 0 8px 8px 0; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; box-shadow: 0 2px 8px rgba(124,58,237,0.08); transition: background .2s, box-shadow .2s, transform .2s; }
          .downloads button:hover { background: linear-gradient(90deg, #6366f1 0%, #7c3aed 100%); box-shadow: 0 4px 16px rgba(124,58,237,0.12); transform: translateY(-2px) scale(1.03); }
          @media (max-width: 700px) { .invoice-dashboard { padding: 16px 4vw; } .filters { flex-direction: column; gap: 10px; align-items: stretch; } #invoiceTable th, #invoiceTable td { padding: 10px 8px; font-size: 14px; } }
        </style>
      </div>
    </div>

    <script>
      function toggleSidebar() {
        const sb = document.getElementById("sidebar");
        const content = document.querySelector(".content");
        const isClosed = sb.classList.toggle("closed");
        content.classList.toggle("full");
        try { localStorage.setItem("sb_closed", isClosed ? "1" : "0"); } catch (e) {}
      }
      function logout() { window.location.href = "user-login.html"; }

      (function initSidebarAndActive() {
        try {
          if (localStorage.getItem("sb_closed") === "1") {
            document.getElementById("sidebar").classList.add("closed");
            const c = document.querySelector(".content"); c && c.classList.add("full");
          }
        } catch (e) {}
        try {
          var path = (location.pathname || '').toLowerCase();
          var file = path.split('/').pop() || 'invoice.html';
          document.querySelectorAll('.sidebar .nav-item').forEach(function (a) {
            var href = (a.getAttribute('href') || '').toLowerCase();
            if (href === file) a.classList.add('active'); else a.classList.remove('active');
          });
        } catch (e) {}
        try {
          document.querySelectorAll('.sidebar .nav-item').forEach(function (a) {
            a.addEventListener('click', function () {
              if (window.matchMedia('(max-width: 900px)').matches) {
                const sb = document.getElementById('sidebar');
                const c = document.querySelector('.content');
                sb.classList.add('closed'); c && c.classList.add('full');
                try { localStorage.setItem('sb_closed', '1'); } catch (e) {}
              }
            });
          });
        } catch (e) {}
      })();
    </script>

    <!-- i18n -->
    <script>
      (function () {
        const I18N = {
          en: {
            nav: { home: "Home", contact: "Contact Us" },
            sidebar: { invoice: "Invoice", tracking: "Tracking", settings: "Settings" },
            auth: { signOut: "Sign out" },
            invoice: {
              title: "Invoice Dashboard",
              search: "Search by Invoice ID",
              all: "All", paid: "Paid", pending: "Pending", overdue: "Overdue",
              table: { invoice: "Invoice #", date: "Date", service: "Service", amount: "Amount", status: "Status" },
              downloadSelected: "Download Selected PDF",
              downloadAll: "Download All PDF",
              downloadCsv: "Download CSV",
              listTitle: "Invoice List"
            }
          },
          fr: {
            nav: { home: "Accueil", contact: "Nous contacter" },
            sidebar: { invoice: "Facture", tracking: "Suivi", settings: "Paramètres" },
            auth: { signOut: "Se déconnecter" },
            invoice: {
              title: "Tableau des factures",
              search: "Rechercher par numéro de facture",
              all: "Tous", paid: "Payée", pending: "En attente", overdue: "En retard",
              table: { invoice: "Facture #", date: "Date", service: "Service", amount: "Montant", status: "Statut" },
              downloadSelected: "Télécharger la sélection en PDF",
              downloadAll: "Tout télécharger en PDF",
              downloadCsv: "Télécharger CSV",
              listTitle: "Liste des factures"
            }
          },
          es: {
            nav: { home: "Inicio", contact: "Contáctanos" },
            sidebar: { invoice: "Factura", tracking: "Seguimiento", settings: "Configuración" },
            auth: { signOut: "Cerrar sesión" },
            invoice: {
              title: "Panel de Facturas",
              search: "Buscar por ID de factura",
              all: "Todas", paid: "Pagada", pending: "Pendiente", overdue: "Vencida",
              table: { invoice: "Factura #", date: "Fecha", service: "Servicio", amount: "Importe", status: "Estado" },
              downloadSelected: "Descargar PDF seleccionado",
              downloadAll: "Descargar todo en PDF",
              downloadCsv: "Descargar CSV",
              listTitle: "Lista de facturas"
            }
          },
          de: {
            nav: { home: "Startseite", contact: "Kontakt" },
            sidebar: { invoice: "Rechnung", tracking: "Verfolgung", settings: "Einstellungen" },
            auth: { signOut: "Abmelden" },
            invoice: {
              title: "Rechnungsübersicht",
              search: "Nach Rechnungs-ID suchen",
              all: "Alle", paid: "Bezahlt", pending: "Ausstehend", overdue: "Überfällig",
              table: { invoice: "Rechnung #", date: "Datum", service: "Leistung", amount: "Betrag", status: "Status" },
              downloadSelected: "Ausgewählte PDF herunterladen",
              downloadAll: "Alle als PDF herunterladen",
              downloadCsv: "CSV herunterladen",
              listTitle: "Rechnungsliste"
            }
          },
          ar: {
            nav: { home: "الرئيسية", contact: "اتصل بنا" },
            sidebar: { invoice: "الفواتير", tracking: "التذاكر", settings: "الإعدادات" },
            auth: { signOut: "تسجيل الخروج" },
            invoice: {
              title: "لوحة الفواتير",
              search: "البحث برقم الفاتورة",
              all: "الكل", paid: "مدفوعة", pending: "معلقة", overdue: "متأخرة",
              table: { invoice: "رقم الفاتورة", date: "التاريخ", service: "الخدمة", amount: "المبلغ", status: "الحالة" },
              downloadSelected: "تحميل المحدد PDF",
              downloadAll: "تحميل الكل PDF",
              downloadCsv: "تحميل CSV",
              listTitle: "قائمة الفواتير"
            }
          },
          ja: {
            nav: { home: "ホーム", contact: "お問い合わせ" },
            sidebar: { invoice: "請求書", tracking: "チケット", settings: "設定" },
            auth: { signOut: "サインアウト" },
            invoice: {
              title: "請求書ダッシュボード",
              search: "請求書IDで検索",
              all: "すべて", paid: "支払い済み", pending: "保留", overdue: "期限切れ",
              table: { invoice: "請求書 #", date: "日付", service: "サービス", amount: "金額", status: "ステータス" },
              downloadSelected: "選択したPDFをダウンロード",
              downloadAll: "すべてPDFをダウンロード",
              downloadCsv: "CSVをダウンロード",
              listTitle: "請求書一覧"
            }
          }
        };

        function getI18n(path, lang) {
          return path.split('.').reduce((o, k) => (o || {})[k], I18N[lang] || {});
        }

        function applyI18n(lang) {
          document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
          window.currentLang = lang;

          document.querySelectorAll('[data-i18n]').forEach(el => {
            const path = el.getAttribute('data-i18n');
            const val = getI18n(path, lang);
            if (typeof val === 'string') el.textContent = val;
          });

          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const path = el.getAttribute('data-i18n-placeholder');
            const val = getI18n(path, lang);
            if (typeof val === 'string') el.setAttribute('placeholder', val);
          });
        }

        document.addEventListener('DOMContentLoaded', function () {
          const sel = document.getElementById('langSel');
          let lang = localStorage.getItem('lang') || 'en';
          if (sel) {
            sel.value = lang;
            sel.addEventListener('change', function () {
              lang = sel.value;
              localStorage.setItem('lang', lang);
              applyI18n(lang);
            });
          }
          applyI18n(lang);
        });

        // Expose I18N globally for other scripts (e.g., downloadAllPDF title)
        try { window.I18N = I18N; } catch (e) {}
      })();
    </script>
  </div>
</body>

</html>