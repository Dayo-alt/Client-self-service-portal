<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings</title>
  <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

   <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
        <script type="text/javascript" src="invoice.js" defer></script>
    <!-- jsPDF core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

  <!-- shared nav + sidebar -->
 <div class="navbar">
  <div class="left">
    <span class="menu-btn" onclick="toggleSidebar()">â˜°</span>
  </div>

  <div class="center links">
    <a href="invoice.html">Home</a>
    <a href="#">Contact Us</a>
  </div>

  <div class="right profile-icon">
    <a href="profile.html">
      <span class="material-symbols-outlined">account_circle</span>
    </a>
  </div>
</div>


  <div class="sidebar" id="sidebar">
    <div class="menu">
      <a class="red" href="invoice.html">Invoice</a>
      <a class="purple" href="ticket.html">Ticket</a>
      <a class="green" href="settings.html">Settings</a>
    </div>
    <div class="logout" onclick="logout()">Log Out</div>
  </div>

  <!-- content -->
  <div class="content">
    <div class="pag">
       <style>
    :root{
      --bg: #ffffff;
      --card: #9b9b9b;
      --muted: #000000;
      --white: #101010;
      --accent: #6fb77c;
      --accent-2: #4f8f64;
      --warning: #c99620;
      --danger: #bc3200;
      --good: #00ba00;
      --ink: #08100f;
      --glass: rgba(0, 0, 0, 0.1);
      --shadow: 0 14px 40px rgba(0,0,0,0.6);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background: linear-gradient(180deg,#838383cc,#5a8a6f); color:var(--white); -webkit-font-smoothing:antialiased; }
    .wrap { max-width:1200px; margin:32px auto; padding:24px; }

    header { display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:18px; }
    .title small { display:block; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:1px; }
    .title h1 { margin:0; font-size:20px; font-weight:800; }

    .sync { display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px; }
    .dot { width:10px; height:10px; border-radius:12px; background:var(--good); box-shadow:0 0 0 4px rgba(127,183,127,.09); }
    .dot.syncing { background:var(--warning); box-shadow:0 0 0 4px rgba(227,179,65,.12); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{ transform:scale(1); } 50%{ transform:scale(1.2);} 100%{ transform:scale(1); } }

    .grid { display:grid; grid-template-columns: 1.15fr 1fr; gap:20px; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015)); border:1px solid rgba(255,255,255,0.04); border-radius:14px; box-shadow:var(--shadow); overflow:hidden; }
    .panel .h { padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center; }
    .panel .h .t { font-weight:700; }
    .panel .b { padding:16px; }

    .sub { border-radius:12px; padding:12px; margin-bottom:12px; background:rgba(255,255,255,0.015); display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(255,255,255,0.02); }
    .sub .info { max-width:70%; }
    .sub h4 { margin:0 0 6px 0; font-size:15px; }
    .meta { color:var(--muted); font-size:13px; }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; color:var(--white); background:linear-gradient(90deg,var(--accent),var(--accent-2)); font-size:12px; border:1px solid rgba(0,0,0,0.15); }

    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:var(--ink); font-weight:700; cursor:pointer; box-shadow: 0 8px 18px rgba(0,0,0,0.45); }
    .btn.ghost { background:transparent; color:var(--white); border:1px dashed rgba(255,255,255,0.12); font-weight:600; }
    .btn.small { padding:8px 10px; font-size:13px; border-radius:10px; }

    label { display:block; font-size:13px; color:var(--muted); margin-bottom:8px; }
    input[type="text"], input[type="password"], input[type="number"], textarea, select, input[type="datetime-local"] { width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:var(--glass); color:var(--white); outline:none; font-size:14px; }
    input::placeholder{ color:rgba(255,255,255,0.5); }

    .inline { display:flex; gap:12px; align-items:center; }
    .inline.space { justify-content:space-between; }

    /* Toggle */
    .toggle { position:relative; width:56px; height:32px; background:rgba(255,255,255,0.06); border-radius:999px; border:1px solid rgba(255,255,255,0.06); cursor:pointer; display:inline-block; vertical-align:middle; }
    .toggle .knob { position:absolute; width:26px; height:26px; border-radius:999px; top:3px; left:3px; background:var(--white); transition:left .18s ease; box-shadow:0 6px 18px rgba(0,0,0,.45); }
    .toggle.on { background: linear-gradient(90deg,var(--accent),var(--accent-2)); }
    .toggle.on .knob { left:27px; }

    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:6px 10px; border-radius:999px; display:inline-flex; gap:8px; align-items:center; font-size:13px; }
    .chip .x { cursor:pointer; opacity:.85; }

    .range-wrap { display:flex; gap:12px; align-items:center; }
    .range-wrap input[type="range"]{ width:100%; }

    .help { font-size:12px; color:var(--muted); margin-top:6px; }

    .toast-wrap { position:fixed; top:18px; right:18px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
    .toast { padding:12px 14px; border-radius:10px; background:#f4f4f4; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.45); min-width:240px; font-weight:700; }
    .toast small { font-weight:500; display:block; color:#333; margin-top:6px; }

    /* Modal */
    .backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9998; }
    .modal { width:520px; max-width:calc(100% - 40px); background:var(--card); border-radius:12px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.04); overflow:hidden; }
    .modal .h { padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.03); font-weight:800; }
    .modal .b { padding:16px; }

    @media (max-width:980px){
      .grid{ grid-template-columns: 1fr; }
      .wrap{ padding:14px; }
    }
  </style>
  <!-- Firebase compat (v9) so old-style firebase.* API works -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <small>Settings</small>
        <h1>Manage Service Settings</h1>
      </div>
      <div class="sync" id="syncBadge"><div class="dot"></div><div id="syncText">Synced with backend</div></div>
    </header>

    <div class="grid">
      <!-- LEFT: Subscription Overview -->
      <section class="panel">
        <div class="h"><span class="t">Subscription Overview</span><div class="help">Manage active services & plans</div></div>
        <div class="b" id="subsBox">
          <!-- subscription cards injected here -->
        </div>
      </section>

      <!-- RIGHT: Automated Actions & Controls -->
      <section class="panel">
        <div class="h"><span class="t">Service Controls</span><div class="help">Toggle features & set limits</div></div>
        <div class="b">
          <div class="row" id="controlsRow">
            <!-- left column of controls -->
            <div>
              <label>Enable / Disable Features</label>
              <div class="inline space" style="margin-top:8px;">
                <span>Auto-Scaling</span>
                <div class="toggle" data-key="features.autoScaling"><div class="knob"></div><input type="checkbox" style="display:none"></div>
              </div>
              <div class="inline space" style="margin-top:10px;">
                <span>Daily Backups</span>
                <div class="toggle" data-key="features.backups"><div class="knob"></div><input type="checkbox" style="display:none"></div>
              </div>
              <div class="inline space" style="margin-top:10px;">
                <span>Advanced Analytics</span>
                <div class="toggle" data-key="features.analytics"><div class="knob"></div><input type="checkbox" style="display:none"></div>
              </div>

              <div style="margin-top:14px;">
                <label for="apiKey">API Key</label>
                <div class="inline" style="gap:8px;">
                  <input type="password" id="apiKey" readonly />
                  <button class="btn small ghost" id="toggleKey">Show</button>
                  <button class="btn small ghost" id="copyKey">Copy</button>
                  <button class="btn small" id="regenKey">Regenerate</button>
                </div>
                <div class="help">This key is used by clients to talk to your service.</div>
              </div>
            </div>

            <!-- right column of controls -->
            <div>
              <label>Notification Preferences</label>
              <div class="inline" style="gap:10px;"><input id="nEmail" type="checkbox" /> <span>Email</span></div>
              <div class="inline" style="margin-top:8px; gap:10px;"><input id="nSms" type="checkbox" /> <span>SMS</span></div>
              <div class="inline" style="margin-top:8px; gap:10px;"><input id="nInApp" type="checkbox" /> <span>In-App</span></div>

              <label style="margin-top:12px">Frequency</label>
              <select id="nFreq">
                <option>Immediate</option>
                <option>Hourly Digest</option>
                <option>Daily Digest</option>
                <option>Weekly Digest</option>
              </select>

              <div style="margin-top:14px;">
                <label>Allowed IP Addresses</label>
                <div class="inline" style="gap:8px;">
                  <input type="text" id="ipInput" placeholder="e.g., 192.168.0.25" />
                  <button class="btn small" id="addIp">Add</button>
                </div>
                <div class="chips" id="ipChips"></div>
                <div class="help">Whitelist specific IPs for sensitive endpoints.</div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label>Bandwidth Limit (GB / month)</label>
              <div class="range-wrap">
                <input type="range" id="bwRange" min="10" max="1000" step="10" />
                <input type="number" id="bwNumber" min="10" max="1000" step="10" style="width:110px;" />
              </div>
              <div class="help">Larger value allows more data transfer per month.</div>
            </div>
            <div>
              <label>Backend Integration</label>
              <div class="help">Changes propagate instantly to your provisioning / CRM system.</div>
              <div class="inline" style="margin-top:8px;">
                <button class="btn small" id="forceSync">Force Sync Now</button>
                <div class="help" id="lastSync" style="margin-left:8px;">Last synced just now.</div>
              </div>
            </div>
          </div>

          <hr style="border-color: rgba(255,255,255,0.04); margin:16px 0;" />

          <label for="pauseStart">Schedule a pause (service temporarily stopped)</label>
          <div class="row">
            <div>
              <input type="datetime-local" id="pauseStart" />
              <div class="help">When should the pause start?</div>
            </div>
            <div>
              <input type="datetime-local" id="pauseEnd" />
              <div class="help">When should the service resume?</div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn small" id="setPause">Set Schedule</button>
            <button class="btn small ghost" id="clearPause">Clear Schedule</button>
            <div id="pauseStatus" class="help" style="margin-top:10px;">No pause scheduled.</div>
          </div>

          <div style="margin-top:14px;">
            <label>Reactivation</label>
            <div class="inline" style="gap:12px;">
              <button class="btn" id="reactivateNow">Request Immediate Reactivation</button>
              <div class="help">Bring services back online now.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Toasts -->
    <div class="toast-wrap" id="toasts"></div>

    <!-- Modal: Change Plan -->
    <div class="backdrop" id="modalBg" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="h">Change Plan</div>
        <div class="b">
          <div id="planList"></div>
          <div class="inline" style="justify-content:flex-end; margin-top:10px; gap:8px;">
            <button class="btn small ghost" id="cancelPlan">Cancel</button>
            <button class="btn small" id="savePlan">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

  /***********************
   *  CONFIG â€” REQUIRED  *
   ***********************
   * Replace the firebaseConfig below with your project's config.
   * Replace USER_DOC_ID with a proper ID (user id or account id).
   *
   * Example: const USER_DOC_ID = "user_abc123";
   ************************/
  const firebaseConfig = {  
    apiKey: "AIzaSyD7eBbx6u7Tmi6Kr097A5yVL_NSRbsId6g",
    authDomain: "client-self-service-portal.firebaseapp.com",
    projectId: "client-self-service-portal",
    storageBucket: "client-self-service-portal.firebasestorage.app",
    messagingSenderId: "423657022971",
    appId: "1:423657022971:web:d58cd5730591b0e121175e",
    measurementId: "G-EDW6QM7B76"
  };

  // âœ… Define your user doc ID here (instead of stray .set call)
  const USER_DOC_ID = "dayo123"; // change this to your actual user id or doc id

  // ---------- tiny helpers ----------
  function $(s){ return document.querySelector(s); }
  function el(t,a={},children=[]){ const d=document.createElement(t); for(const k in a){ if(k==='class') d.className=a[k]; else if(k==='html') d.innerHTML=a[k]; else d.setAttribute(k,a[k]); } (children||[]).forEach(c=>d.appendChild(c)); return d; }
  function showToast(title, desc='', ttl=3500){ const t=el('div',{class:'toast', html:`<div>${title}</div>${desc?`<small>${desc}</small>`:''}`}); $('#toasts').appendChild(t); setTimeout(()=> t.style.opacity='0.02', ttl-350); setTimeout(()=> t.remove(), ttl); }

  // ... ðŸ”½ everything else in your script stays the same ðŸ”½ ...


    // ---------- Default state ----------
    const defaultState = {
      subscriptions: [
        { id:'sub1', name:'Cloud Storage', plan:'Pro', price:29, period:'mo', expiry:'2025-12-31', status:'Active' },
        { id:'sub2', name:'API Access', plan:'Basic', price:9, period:'mo', expiry:'2025-10-15', status:'Active' }
      ],
      features: { autoScaling:true, backups:true, analytics:false },
      apiKey: genKey(),
      notifications: { email:true, sms:false, inApp:true, frequency:'Immediate' },
      allowedIPs: ['192.168.0.25'],
      bandwidth: 200,
      pause: null, // { startISO, endISO }
      lastSynced: Date.now()
    };

    // Local state (will be replaced by DB if available)
    let state = loadLocalState() || defaultState;

    // ---------- persistence helpers ----------
    function loadLocalState(){ try{ const raw = localStorage.getItem('svc-settings-state'); if(raw) return JSON.parse(raw); }catch(e){} return null; }
    function saveLocalState(){ try{ localStorage.setItem('svc-settings-state', JSON.stringify(state)); }catch(e){} }
    function genKey(){ const chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s='sk_live_'; for(let i=0;i<28;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
    function timeAgo(ts){ const s=Math.floor((Date.now()-ts)/1000); if(s<60) return s+'s'; const m=Math.floor(s/60); if(m<60) return m+'m'; const h=Math.floor(m/60); if(h<24) return h+'h'; const d=Math.floor(h/24); return d+'d'; }

    // ---------- UI renderers ----------
    function renderSubs(){
      const box = $('#subsBox'); box.innerHTML='';
      state.subscriptions.forEach(sub=>{
        const left = el('div',{class:'info'});
        left.appendChild(el('h4',{html: `${sub.name} <span class="pill">${sub.plan}</span>`}));
        left.appendChild(el('div',{class:'meta', html: `Expires ${sub.expiry} â€¢ $${sub.price}/${sub.period}`}));
        const right = el('div');
        const btn = el('button',{class:'btn small'}); btn.textContent='Upgrade / Downgrade';
        btn.addEventListener('click', ()=> openPlanModal(sub.id));
        right.appendChild(btn);
        const row = el('div',{class:'sub'});
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
    }

    // toggles
    function renderToggles(){
      document.querySelectorAll('.toggle').forEach(tg=>{
        const key = tg.getAttribute('data-key'); // e.g., "features.autoScaling"
        const val = getNested(state, key);
        tg.classList.toggle('on', !!val);
        const input = tg.querySelector('input');
        if(input) input.checked = !!val;
        // click
        tg.onclick = () => {
          const now = !tg.classList.contains('on');
          tg.classList.toggle('on', now);
          setNested(state, key, now);
          saveLocalState();
          showToast('Feature updated', `${key.split('.').pop()} is ${now?'enabled':'disabled'}`);
          syncToBackendDebounced();
        };
      });
    }

    function renderApiKey(){
      $('#apiKey').value = state.apiKey || '';
    }

    function renderNotifications(){
      $('#nEmail').checked = !!state.notifications.email;
      $('#nSms').checked = !!state.notifications.sms;
      $('#nInApp').checked = !!state.notifications.inApp;
      $('#nFreq').value = state.notifications.frequency || 'Immediate';
    }

    function renderIPs(){
      const box = $('#ipChips'); box.innerHTML = '';
      (state.allowedIPs||[]).forEach(ip=>{
        const c = el('div',{class:'chip'},[document.createTextNode(ip)]);
        const x = el('span',{class:'x', html:'\u2715'});
        x.onclick = ()=>{
          state.allowedIPs = state.allowedIPs.filter(v=>v!==ip);
          saveLocalState();
          renderIPs();
          showToast('Removed IP', ip);
          syncToBackendDebounced();
        };
        c.appendChild(x); box.appendChild(c);
      });
    }

    function renderBandwidth(){
      $('#bwRange').value = state.bandwidth || 10;
      $('#bwNumber').value = state.bandwidth || 10;
    }

    function renderPause(){
      const p = state.pause;
      if(!p){ $('#pauseStatus').textContent = 'No pause scheduled.'; return; }
      const s = new Date(p.startISO); const e = new Date(p.endISO);
      $('#pauseStatus').textContent = `Paused from ${s.toLocaleString()} to ${e.toLocaleString()}.`;
    }

    function renderSyncBadge(){
      const dot = $('#syncBadge .dot'); const txt = $('#syncText');
      dot.classList.remove('syncing'); dot.style.background = 'var(--good)';
      txt.textContent = 'Synced with backend';
      $('#lastSync').textContent = 'Last synced ' + timeAgo(state.lastSynced) + '.';
    }

    function renderAll(){ renderSubs(); renderToggles(); renderApiKey(); renderNotifications(); renderIPs(); renderBandwidth(); renderPause(); renderSyncBadge(); }

    // nested object helpers (key like "features.autoScaling")
    function getNested(obj, key){ return key.split('.').reduce((o,k)=> o ? o[k] : undefined, obj); }
    function setNested(obj, key, value){
      const parts = key.split('.'); let cur = obj;
      for(let i=0;i<parts.length-1;i++){ if(!cur[parts[i]]) cur[parts[i]] = {}; cur = cur[parts[i]]; }
      cur[parts[parts.length-1]] = value;
    }

    // ---------- Plan modal ----------
    const plans = [
      { name:'Basic', price:9, features:'Good for starters' },
      { name:'Pro', price:29, features:'More power & support' },
      { name:'Enterprise', price:99, features:'Highest limits & SLA' }
    ];
    let modalSubId = null;

    function openPlanModal(subId){
      modalSubId = subId;
      const list = $('#planList'); list.innerHTML='';
      const current = state.subscriptions.find(s=>s.id===subId).plan;
      plans.forEach(p=>{
        const row = el('label',{class:'plan'});
        const radio = el('input',{type:'radio', name:'planRadio', value:p.name});
        if(p.name === current) radio.checked = true;
        const left = el('div',{html:`<div style="font-weight:800;">${p.name}</div><div class="help">${p.features}</div>`});
        const right = el('div',{html:`<div style="font-weight:800;">$${p.price}/mo</div>`});
        row.appendChild(radio); row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      });
      $('#modalBg').style.display = 'flex';
    }
    function closePlanModal(){ $('#modalBg').style.display = 'none'; }
    $('#cancelPlan').addEventListener('click', closePlanModal);
    $('#savePlan').addEventListener('click', ()=>{
      const checked = document.querySelector('input[name="planRadio"]:checked');
      if(!checked) { closePlanModal(); return; }
      const newPlan = checked.value;
      const sub = state.subscriptions.find(s=>s.id===modalSubId);
      const pj = plans.find(p=>p.name===newPlan);
      if(sub){ sub.plan = pj.name; sub.price = pj.price; saveLocalState(); renderSubs(); showToast('Plan updated', `${sub.name} â†’ ${pj.name} ($${pj.price}/mo)`); syncToBackend(); }
      closePlanModal();
    });

    // ---------- interactions ----------
    $('#toggleKey').addEventListener('click', ()=>{
      const inp = $('#apiKey'); const isPwd = inp.type === 'password';
      inp.type = isPwd ? 'text' : 'password'; $('#toggleKey').textContent = isPwd ? 'Hide' : 'Show';
    });
    $('#copyKey').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText($('#apiKey').value); showToast('Copied','API key copied'); }catch(e){ showToast('Copy failed','Browser blocked copy'); }
    });
    $('#regenKey').addEventListener('click', ()=>{
      state.apiKey = genKey(); saveLocalState(); renderApiKey(); showToast('New API key','Regenerated'); syncToBackend();
    });

    // notification input listeners
    ['nEmail','nSms','nInApp','nFreq'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=>{
        state.notifications = { email: !!$('#nEmail').checked, sms: !!$('#nSms').checked, inApp: !!$('#nInApp').checked, frequency: $('#nFreq').value };
        saveLocalState();
        showToast('Notification preferences saved');
        syncToBackendDebounced();
      });
    });

    // IPs
    $('#addIp').addEventListener('click', ()=>{
      const ip = $('#ipInput').value.trim();
      if(!ip) return;
      if(!/^((25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3})$/.test(ip)){
        showToast('Invalid IP','Enter IPv4 like 192.168.0.25'); return;
      }
      if(state.allowedIPs.includes(ip)){ showToast('Duplicate IP','Already allowed'); return; }
      state.allowedIPs.push(ip); $('#ipInput').value=''; saveLocalState(); renderIPs(); showToast('IP added', ip); syncToBackend();
    });

    // bandwidth
    $('#bwRange').addEventListener('input', e=> { $('#bwNumber').value = e.target.value; });
    $('#bwRange').addEventListener('change', e=> { state.bandwidth = Number(e.target.value); saveLocalState(); showToast('Bandwidth updated', state.bandwidth+' GB/month'); syncToBackendDebounced(); });
    $('#bwNumber').addEventListener('change', e=> { const v = Number(e.target.value)||10; state.bandwidth = Math.min(1000, Math.max(10, v)); renderBandwidth(); saveLocalState(); showToast('Bandwidth updated', state.bandwidth+' GB/month'); syncToBackendDebounced(); });

    // pause/reactivate
    $('#setPause').addEventListener('click', ()=>{
      const s = $('#pauseStart').value, e = $('#pauseEnd').value;
      if(!s||!e){ showToast('Missing times','Choose start and end'); return; }
      if(new Date(s) >= new Date(e)){ showToast('Invalid range','End must be after start'); return; }
      state.pause = { startISO: s, endISO: e }; saveLocalState(); renderPause(); showToast('Pause scheduled','Service will pause at chosen time'); syncToBackend();
    });
    $('#clearPause').addEventListener('click', ()=>{ state.pause=null; saveLocalState(); renderPause(); showToast('Pause cleared'); syncToBackend(); });
    $('#reactivateNow').addEventListener('click', ()=>{ state.pause=null; saveLocalState(); renderPause(); showToast('Reactivation requested'); syncToBackend(); });

    // force sync
    $('#forceSync').addEventListener('click', ()=>{ syncToBackend(true); });

    // modal close on backdrop
    $('#modalBg').addEventListener('click', (e)=>{ if(e.target.id==='modalBg') closePlanModal(); });

    // ---------- Firebase wiring ----------
    let db = null;
    let settingsDoc = null;
    let syncTimer = null;
    let lastLocalSync = 0;

    function initFirebase(){
      try{
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        settingsDoc = db.collection('serviceSettings').doc(USER_DOC_ID);
        // listen for remote updates
        settingsDoc.onSnapshot((doc)=>{
          if(!doc.exists) return;
          const remote = doc.data();
          // Avoid overriding local edits that are very fresh:
          // If we recently did a local sync (<1s), prefer local for a tiny bit to avoid race.
          const now = Date.now();
          if(now - lastLocalSync < 800) {
            // merge but do not clobber immediate local changes
            state = { ...remote, ...state };
          } else {
            state = { ...state, ...remote };
          }
          saveLocalState();
          renderAll();
        }, err => {
          console.error('onSnapshot error', err);
          showToast('Realtime error', err.message || 'Check console');
        });

        // initial read: if doc exists we use it; else push local default
        settingsDoc.get().then(doc=>{
          if(doc.exists){
            state = { ...state, ...doc.data() };
            saveLocalState();
            renderAll();
          } else {
            // write initial local state to backend
            syncToBackend(true);
          }
        }).catch(e=>{
          console.warn('Initial read failed', e);
          // still render local
          renderAll();
        });

      }catch(e){
        console.error('Firebase init failed', e);
        showToast('Firebase init failed', 'Insert correct config and ensure Firestore is enabled.');
        renderAll();
      }
    }

    // full sync (immediate when urgent). If immediate flag true, do not debounce.
    function syncToBackend(immediate=false){
      if(!settingsDoc){ console.warn('No settingsDoc configured'); showToast('Not connected', 'Insert firebaseConfig & USER_DOC_ID'); return Promise.resolve(); }
      if(!immediate){
        return syncToBackendDebounced();
      }
      // write current state to firestore
      const payload = { ...state, lastSynced: Date.now() };
      lastLocalSync = Date.now();
      // keep only JSON-serializable fields (state is safe)
      return settingsDoc.set(payload, { merge:true })
        .then(()=>{
          state.lastSynced = payload.lastSynced;
          saveLocalState();
          renderSyncBadge();
        })
        .catch(err=>{
          console.error('sync error', err);
          showToast('Sync failed', err.message || 'See console');
        });
    }

    function syncToBackendDebounced(){
      if(!settingsDoc){ showToast('Not connected', 'Insert firebaseConfig & USER_DOC_ID'); return Promise.resolve(); }
      clearTimeout(syncTimer);
      const badgeDot = $('#syncBadge .dot');
      const syncTxt = $('#syncText');
      badgeDot.classList.add('syncing'); syncTxt.textContent = 'Syncing to backendâ€¦';
      return new Promise((resolve)=>{
        syncTimer = setTimeout(()=>{
          const payload = { ...state, lastSynced: Date.now() };
          lastLocalSync = Date.now();
          settingsDoc.set(payload, { merge:true })
            .then(()=> {
              state.lastSynced = payload.lastSynced;
              saveLocalState();
              badgeDot.classList.remove('syncing');
              syncTxt.textContent = 'Synced with backend';
              $('#lastSync').textContent = 'Last synced ' + timeAgo(state.lastSynced) + '.';
              resolve();
            })
            .catch(err=>{
              console.error('debounced sync error', err);
              badgeDot.classList.remove('syncing');
              syncTxt.textContent = 'Sync error';
              showToast('Sync failed', err.message || 'See console');
              resolve();
            });
        }, 650); // 650ms debounce
      });
    }

    // ---------- boot ----------
    function boot(){
      renderAll();
      // wire some immediate UI listeners (that need to reflect state)
      $('#bwRange').value = state.bandwidth; $('#bwNumber').value = state.bandwidth;
      // parity: toggles already handled in renderToggles
      // listen to manual small items (range number input change handled already)
      // when user interacts with the knobs we already call syncToBackendDebounced in handlers above
    }

    // initialize UI from local state and then init Firebase
    document.addEventListener('DOMContentLoaded', ()=>{
      boot();
      // initialize firebase after render so UI shows up even if config absent
      initFirebase();
    });

    // ---------- utilities for quick save actions (used by many handlers) ----------
    function quickSaveAndSync(desc){
      saveLocalState();
      showToast(desc || 'Saved');
      syncToBackendDebounced();
    }

    // override simulateBackendSync calls in older code: expose global simulateBackendSync
    function simulateBackendSync(){ syncToBackend(); }

    // Expose some functions to window for ease of testing from console (optional)
    window._svc = {
      getState: ()=>state,
      syncNow: ()=>syncToBackend(true),
      simulateBackendSync
    };
  </script>
</body>
</html>

    </div>
  </div>
<!-- 
  <div class="navbar">
  <span class="menu-btn" onclick="toggleSidebar()">â˜°</span>
  <div class="links">
    <a href="#">Link1</a>
    <a href="#">Link2</a>
    <a href="#">Link3</a>
  </div>
</div> -->

<!-- <div class="sidebar" id="sidebar">
  <div class="menu">
    <a class="red" href="invoice.html">1st Page</a>
    <a class="purple" href="ticket.html">2nd Page</a>
    <a class="green" href="settings.html">3rd Page</a>
  </div>
  <div class="logout" onclick="logout()">Log Out</div>
</div> -->

<script>
  function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("closed");
    document.querySelector(".content").classList.toggle("full");
  }
  function logout() {
    window.location.href = "login.html";
  }
</script>
<!-- 

  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("closed");
      document.querySelector(".content").classList.toggle("full");
    }
    function logout() {
      window.location.href = "login.html";
    }
  </script> -->
</body>
</html>
